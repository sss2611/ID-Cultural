name: IntegraciÃ³n Continua (CI)

on:
push:
branches: [ "main", "develop" ]
pull_request:
branches: [ "main", "develop" ]
workflow_dispatch: # Permite ejecutar el workflow manualmente

jobs:
build_and_test:
runs-on: ubuntu-latest

steps:
- name: ğŸ“¥ Clonar Repositorio
  uses: actions/checkout@v4

- name: ğŸ—ï¸ Levantar la AplicaciÃ³n y Servicios con Docker Compose
  # Los flags --build y --wait son clave aquÃ­.
  # --wait espera que los contenedores estÃ©n 'healthy' o que salgan.
  run: docker-compose up -d --build --wait

- name: â³ Esperar un momento adicional para la inicializaciÃ³n de la BD (opcional)
  # Darle unos segundos extra a MariaDB para que el script SQL se ejecute.
  run: sleep 15

# ----------------------------------------------------
# PASO CLAVE: EjecuciÃ³n de las Pruebas
# ----------------------------------------------------
- name: ğŸ§ª Ejecutar Pruebas (asumiendo PHPUnit)
  # SERVICIO: 'web' (confirmado en el docker-compose.yml)
  # COMANDO: 'vendor/bin/phpunit' (si usas PHPUnit, cÃ¡mbialo si usas otro)
  run: docker-compose exec -T web vendor/bin/phpunit
  
  # Si usas Laravel, probablemente serÃ­a:
  # run: docker-compose exec -T web php artisan test

# ----------------------------------------------------
  
- name: ğŸ›‘ Limpiar y Detener Contenedores
  if: always() # Importante: Se ejecuta incluso si el paso de pruebas falla.
  run: docker-compose down
